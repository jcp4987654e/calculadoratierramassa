<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de Puesta a Tierra TT (AEA) v2.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuración de MathJax para renderizar fórmulas LaTeX
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        .tab-button.active { border-color: #3b82f6; color: #3b82f6; background-color: #1f2937; }
        .tab-button { border-color: #4b5563; }
        .result-section, .mode-section, .electrode-params { display: none; }
        .loader { border: 4px solid #4b5563; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #export-content { position: absolute; left: -9999px; top: -9999px; }
        .sector-card, .info-card { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Tooltip Styles */
        .tooltip-container { position: relative; display: inline-block; cursor: help; }
        .tooltip-icon { font-size: 10px; padding: 2px 6px; border-radius: 50%; background-color: #4b5563; color: white; margin-left: 5px; user-select: none; }
        .tooltip-text { visibility: hidden; width: 250px; background-color: #1f2937; color: #fff; text-align: left; border-radius: 6px; padding: 10px; position: absolute; z-index: 10; bottom: 125%; left: 50%; margin-left: -125px; opacity: 0; transition: opacity 0.3s; border: 1px solid #4b5563; font-size: 0.8rem; pointer-events: none; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8 relative">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Planificador de Puesta a Tierra (Esquema TT)</h1>
            <p class="text-gray-400 mt-2">Diseño de proyecto según reglamentación AEA 90364. v2.2</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-8">

            <!-- Columna de Parámetros -->
            <div class="md:col-span-4 bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-lg">
                <div>
                    <label for="mode_selector" class="block text-sm font-medium text-gray-300 mb-2">Modo de Calculadora</label>
                    <select id="mode_selector" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
                        <option value="domiciliaria">Verificación Domiciliaria</option>
                        <option value="proyecto">Proyecto Completo (Multi-Sector)</option>
                    </select>
                </div>
                
                <hr class="border-gray-600 my-6">

                <!-- Parámetros Comunes -->
                <div class="space-y-6">
                    <h2 class="text-2xl font-semibold -mt-2">1. Parámetros Generales</h2>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Condiciones / Tensión Límite ($U_L$)
                            <span class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Tensión máxima a la que puede quedar sometida una persona indefinidamente. 24V para locales húmedos/exteriores o sin supervisión. 50V para locales secos con personal instruido.</span>
                            </span>
                        </label>
                        <select id="ul_condition" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
                            <option value="24" selected>Común / Sin supervisión (UL = 24V)</option>
                            <option value="50">Seco / Personal capacitado (UL = 50V)</option>
                        </select>
                    </div>
                    <div>
                        <label for="tipo_suelo" class="block text-sm font-medium text-gray-300 mb-2">
                            Resistividad Base del Terreno (ρ)
                             <span class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Oposición del suelo al paso de corriente. Varía según el tipo de suelo. Seleccione un valor de tabla o ingrese uno medido.</span>
                            </span>
                        </label>
                        <select id="tipo_suelo" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 mb-2">
                            <option value="10" selected>Arcillas (10 Ω·m)</option>
                            <option value="5">Aluvial (5 Ω·m)</option>
                            <option value="20">Greda (20 Ω·m)</option>
                            <option value="50">T. calcárea (50 Ω·m)</option>
                            <option value="100">Arenisca (100 Ω·m)</option>
                            <option value="custom">Ingresar valor manual...</option>
                        </select>
                        <input type="number" id="resistividad_manual" placeholder="Ej: 80" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 hidden">
                    </div>
                     <div>
                        <label for="humedad_terreno" class="block text-sm font-medium text-gray-300 mb-2">
                            Condiciones de Humedad del Terreno
                             <span class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Ajusta la resistividad base. La humedad reduce la resistividad. 'Seco' aumenta el valor, 'Húmedo' lo reduce.</span>
                            </span>
                        </label>
                        <select id="humedad_terreno" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
                            <option value="1.5">Seco (aumenta resistividad)</option>
                            <option value="1.0" selected>Normal (valor base)</option>
                            <option value="0.7">Húmedo (reduce resistividad)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Modo Domiciliaria -->
                <div id="mode_domiciliaria" class="mode-section mt-8 space-y-6">
                    <h2 class="text-2xl font-semibold border-b border-gray-600 pb-3">2. Puesta a Tierra a Verificar</h2>
                    <div class="space-y-3">
                         <label class="text-sm font-medium text-gray-300">Sensibilidad Diferencial (IΔn)</label>
                         <select id="domiciliaria_rcd" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
                             <option value="30" selected>30 mA</option><option value="100">100 mA</option><option value="300">300 mA</option>
                             <option value="500">500 mA</option><option value="1000">1 A</option>
                         </select>
                         <div class="mt-2">
                             <label class="flex items-center space-x-2 text-sm cursor-pointer">
                                 <input type="checkbox" id="domiciliaria_manual_obj_check" class="form-checkbox h-4 w-4 text-blue-600 bg-gray-700 border-gray-500 rounded">
                                 <span>Usar objetivo manual de resistencia</span>
                             </label>
                             <input type="number" id="domiciliaria_manual_obj_input" placeholder="Ej: 5 Ω" class="w-full bg-gray-600 border-gray-500 rounded-md px-3 py-1.5 mt-2 hidden">
                         </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-300">Tipo de Electrodo</label>
                        <select id="domiciliaria_electrode_type" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 mt-2">
                            <option value="jabalina_v" selected>Jabalina Vertical</option>
                            <option value="jabalina_h">Jabalina Horizontal</option>
                            <option value="placa">Placa</option>
                            <option value="malla">Malla</option>
                        </select>
                    </div>
                    <!-- Parámetros Jabalina Vertical -->
                    <div id="domiciliaria_jabalina_v_params" class="electrode-params space-y-2">
                         <label class="text-sm font-medium text-gray-300">Dimensiones Jabalina</label>
                         <div class="grid grid-cols-2 gap-2">
                             <select id="domiciliaria_l" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2"><option value="1.5">1.5m</option><option value="3" selected>3m</option></select>
                             <select id="domiciliaria_d" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2"><option value="0.0127">1/2"</option><option value="0.0158">5/8"</option><option value="0.01905" selected>3/4"</option></select>
                         </div>
                    </div>
                    <!-- Parámetros Jabalina Horizontal -->
                    <div id="domiciliaria_jabalina_h_params" class="electrode-params space-y-2">
                        <label class="text-sm font-medium text-gray-300">Dimensiones Conductor Horizontal (m)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="domiciliaria_h_l" value="10" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2" placeholder="Longitud">
                            <input type="number" id="domiciliaria_h_p" value="0.5" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2" placeholder="Profundidad">
                        </div>
                    </div>
                    <!-- Parámetros Placa -->
                    <div id="domiciliaria_placa_params" class="electrode-params space-y-2">
                        <label class="text-sm font-medium text-gray-300">Dimensiones Placa (m)</label>
                        <div class="grid grid-cols-2 gap-2">
                           <input type="number" id="domiciliaria_placa_a" value="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2" placeholder="Lado A">
                           <input type="number" id="domiciliaria_placa_b" value="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2" placeholder="Lado B">
                        </div>
                    </div>
                     <!-- Parámetros Malla -->
                    <div id="domiciliaria_malla_params" class="electrode-params space-y-2">
                        <label class="text-sm font-medium text-gray-300">Dimensiones Malla (m)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="domiciliaria_malla_l" value="5" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2" placeholder="Longitud Total Conductor">
                            <input type="number" id="domiciliaria_malla_A" value="4" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2" placeholder="Área (m²)">
                        </div>
                    </div>
                </div>

                <!-- Modo Proyecto -->
                <div id="mode_proyecto" class="mode-section mt-8">
                     <div class="space-y-6">
                         <h2 class="text-2xl font-semibold border-b border-gray-600 pb-3">2. Puesta a Tierra de Servicio (RB)</h2>
                         <p class="text-xs text-gray-400 -mt-2">Sistema para el neutro de la acometida. Objetivo ≤ 1.0 Ω por defecto.</p>
                         <div>
                             <label class="text-sm font-medium text-gray-300">Jabalina para Servicio</label>
                             <div class="grid grid-cols-2 gap-2 mt-2">
                                 <select id="proyecto_service_l" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2"><option value="1.5">1.5m</option><option value="3" selected>3m</option></select>
                                 <select id="proyecto_service_d" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2"><option value="0.0127">1/2"</option><option value="0.0158">5/8"</option><option value="0.01905" selected>3/4"</option></select>
                             </div>
                         </div>
                         <div>
                             <label class="flex items-center space-x-2 text-sm cursor-pointer">
                                 <input type="checkbox" id="proyecto_service_manual_check" class="form-checkbox h-4 w-4 text-blue-600 bg-gray-700 border-gray-500 rounded">
                                 <span>Usar objetivo manual</span>
                             </label>
                             <input type="number" id="proyecto_service_manual_input" value="1" placeholder="Ej: 0.8 Ω" class="w-full bg-gray-600 border-gray-500 rounded-md px-3 py-1.5 mt-2 hidden">
                         </div>
                     </div>
                    <h2 class="text-2xl font-semibold border-b border-gray-600 pb-3 mb-4 mt-8">3. Sectores de Protección (RA)</h2>
                    <div id="sectores-container" class="space-y-4"></div>
                    <button id="addSectorBtn" class="mt-4 w-full flex items-center justify-center py-2 px-4 border border-dashed border-gray-500 text-sm font-medium rounded-lg text-gray-400 hover:text-white hover:border-white transition">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                        Añadir Sector
                    </button>
                </div>

                <button id="calcularBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg mt-8 hover:bg-blue-700 transition-colors"></button>
            </div>

            <!-- Columna de Resultados -->
            <div class="md:col-span-8">
                <div id="results-container" class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-lg min-h-full" style="display: none;"></div>
                <div id="initial-message" class="flex items-center justify-center bg-gray-800 p-6 rounded-xl border-2 border-dashed border-gray-700 min-h-full">
                    <div class="text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <h3 class="mt-2 text-lg font-medium text-white">Listo para Planificar</h3>
                        <p class="mt-1 text-sm text-gray-400">Seleccione el modo, complete los parámetros y presione "Calcular".</p>
                    </div>
                </div>
                <div id="loader-container" class="hidden items-center justify-center bg-gray-800 p-6 rounded-xl"><div class="loader"></div></div>
            </div>
        </div>
    </div>
    <textarea id="export-content"></textarea>

<script>
// --- DATABASE & DEFAULTS ---
const DB = {
    soilResistivity: { '10': 'Arcillas', '5': 'Aluvial', '20': 'Greda', '50': 'Tierra calcárea', '100': 'Arenisca' },
    parallelCoefficients: { 1: 1.0, 2: 0.57, 3: 0.42, 4: 0.33, 5: 0.27, 6: 0.24, 7: 0.21, 8: 0.19, 9: 0.17, 10: 0.15 },
    aeaTable: { 
        "50": { "30": 1666, "100": 500, "300": 167, "500": 100, "1000": 50, "3000": 17, "5000": 10, "10000": 5, "20000": 2.5 }, 
        "24": { "30": 800, "100": 240, "300": 80, "500": 48, "1000": 24, "3000": 8, "5000": 4.8, "10000": 2.4, "20000": 1.2 } 
    },
    aeaFinalCap: { "30": 40, "100": 40, "300": 40, "500": 24, "1000": 12, "3000": 4, "5000": 2.4, "10000": 1.2, "20000": 0.6 }
};
let sectorCount = 0;
let currentResults = null;

// --- DOM ELEMENTS ---
const getElement = id => document.getElementById(id);
const dom = {
    mode_selector: getElement('mode_selector'),
    mode_proyecto: getElement('mode_proyecto'),
    mode_domiciliaria: getElement('mode_domiciliaria'),
    tipoSuelo: getElement('tipo_suelo'), 
    resistividadManual: getElement('resistividad_manual'),
    humedadTerreno: getElement('humedad_terreno'),
    ul_condition: getElement('ul_condition'),
    calcularBtn: getElement('calcularBtn'), 
    resultsContainer: getElement('results-container'),
    initialMessage: getElement('initial-message'),
    loaderContainer: getElement('loader-container'),
    exportTextarea: getElement('export-content'), 
    addSectorBtn: getElement('addSectorBtn'),
    sectoresContainer: getElement('sectores-container')
};

// --- EVENT LISTENERS ---
function addEventListeners() {
    dom.mode_selector.addEventListener('change', handleModeChange);
    dom.tipoSuelo.addEventListener('change', () => {
        dom.resistividadManual.classList.toggle('hidden', dom.tipoSuelo.value !== 'custom');
        saveState();
    });
    dom.calcularBtn.addEventListener('click', () => {
        if (dom.mode_selector.value === 'proyecto' && document.querySelectorAll('.sector-card').length === 0) {
            alert('Debe añadir al menos un sector de protección.'); return;
        }
        dom.resultsContainer.style.display = 'none';
        dom.initialMessage.style.display = 'none';
        dom.loaderContainer.style.display = 'flex';
        setTimeout(performCalculations, 500);
    });
    dom.addSectorBtn.addEventListener('click', () => { addSector(); saveState(); });

    // Listeners for saving state
    document.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('change', saveState);
        el.addEventListener('keyup', saveState);
    });

    // Listener for electrode type change in Domiciliaria
    getElement('domiciliaria_electrode_type').addEventListener('change', (e) => handleElectrodeTypeChange('domiciliaria', e.target.value));
}

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    addEventListeners();
    loadState();
    handleModeChange();
    if (dom.mode_selector.value === 'proyecto' && document.querySelectorAll('.sector-card').length === 0) {
        addSector();
    }
});

// --- STATE MANAGEMENT (localStorage) ---
function saveState() {
    const state = {
        mode: dom.mode_selector.value,
        ul: dom.ul_condition.value,
        tipoSuelo: dom.tipoSuelo.value,
        resistividadManual: dom.resistividadManual.value,
        humedad: dom.humedadTerreno.value,
        domiciliaria: {
            rcd: getElement('domiciliaria_rcd').value,
            manualCheck: getElement('domiciliaria_manual_obj_check').checked,
            manualInput: getElement('domiciliaria_manual_obj_input').value,
            electrodeType: getElement('domiciliaria_electrode_type').value,
            l: getElement('domiciliaria_l').value,
            d: getElement('domiciliaria_d').value,
            h_l: getElement('domiciliaria_h_l').value,
            h_p: getElement('domiciliaria_h_p').value,
            placa_a: getElement('domiciliaria_placa_a').value,
            placa_b: getElement('domiciliaria_placa_b').value,
            malla_l: getElement('domiciliaria_malla_l').value,
            malla_A: getElement('domiciliaria_malla_A').value,
        },
        proyecto: {
            service_l: getElement('proyecto_service_l').value,
            service_d: getElement('proyecto_service_d').value,
            service_manual_check: getElement('proyecto_service_manual_check').checked,
            service_manual_input: getElement('proyecto_service_manual_input').value,
            sectores: Array.from(document.querySelectorAll('.sector-card')).map(card => ({
                id: card.id,
                name: card.querySelector('.sector-name').value,
                rcd: card.querySelector('.sector-rcd').value,
                manualCheck: card.querySelector('.sector-manual-check').checked,
                manualInput: card.querySelector('.sector-manual-input').value,
                electrodeType: card.querySelector('.sector-electrode-type').value,
                l: card.querySelector('.sector-l').value,
                d: card.querySelector('.sector-d').value,
            }))
        }
    };
    localStorage.setItem('pat_calculator_state', JSON.stringify(state));
}

function loadState() {
    const state = JSON.parse(localStorage.getItem('pat_calculator_state'));
    if (!state) return;

    dom.mode_selector.value = state.mode || 'domiciliaria';
    dom.ul_condition.value = state.ul || '24';
    dom.tipoSuelo.value = state.tipoSuelo || '10';
    dom.resistividadManual.value = state.resistividadManual || '';
    dom.humedadTerreno.value = state.humedad || '1.0';
    dom.resistividadManual.classList.toggle('hidden', dom.tipoSuelo.value !== 'custom');

    // Domiciliaria
    const domState = state.domiciliaria || {};
    getElement('domiciliaria_rcd').value = domState.rcd || '30';
    getElement('domiciliaria_manual_obj_check').checked = domState.manualCheck || false;
    getElement('domiciliaria_manual_obj_input').value = domState.manualInput || '';
    getElement('domiciliaria_manual_obj_input').classList.toggle('hidden', !domState.manualCheck);
    getElement('domiciliaria_electrode_type').value = domState.electrodeType || 'jabalina_v';
    getElement('domiciliaria_l').value = domState.l || '3';
    getElement('domiciliaria_d').value = domState.d || '0.01905';
    getElement('domiciliaria_h_l').value = domState.h_l || '10';
    getElement('domiciliaria_h_p').value = domState.h_p || '0.5';
    getElement('domiciliaria_placa_a').value = domState.placa_a || '1';
    getElement('domiciliaria_placa_b').value = domState.placa_b || '1';
    getElement('domiciliaria_malla_l').value = domState.malla_l || '5';
    getElement('domiciliaria_malla_A').value = domState.malla_A || '4';
    
    // Proyecto
    const proyState = state.proyecto || {};
    getElement('proyecto_service_l').value = proyState.service_l || '3';
    getElement('proyecto_service_d').value = proyState.service_d || '0.01905';
    getElement('proyecto_service_manual_check').checked = proyState.service_manual_check || false;
    getElement('proyecto_service_manual_input').value = proyState.service_manual_input || '1';
    getElement('proyecto_service_manual_input').classList.toggle('hidden', !proyState.service_manual_check);
    
    dom.sectoresContainer.innerHTML = '';
    sectorCount = 0;
    if (proyState.sectores && proyState.sectores.length > 0) {
        proyState.sectores.forEach(s => addSector(s));
    }
}

// --- CORE FUNCTIONS ---
function handleModeChange() {
    const selectedMode = dom.mode_selector.value;
    document.querySelectorAll('.mode-section').forEach(el => el.style.display = 'none');
    const modeElement = getElement(`mode_${selectedMode}`);
    modeElement.style.display = 'block';

    // *** FIX ***: When switching to Domiciliaria mode, ensure the correct electrode parameters are displayed.
    if (selectedMode === 'domiciliaria') {
        const selectedElectrode = getElement('domiciliaria_electrode_type').value;
        handleElectrodeTypeChange('domiciliaria', selectedElectrode);
    }

    dom.resultsContainer.style.display = 'none';
    dom.initialMessage.style.display = 'flex';
    dom.calcularBtn.textContent = selectedMode === 'proyecto' ? 'Calcular Proyecto Completo' : 'Verificar Puesta a Tierra';
    saveState();
}

function handleElectrodeTypeChange(prefix, type, card) {
    const container = card || document;
    container.querySelectorAll(`[id^=${prefix}_][id$=_params]`).forEach(el => el.style.display = 'none');
    const selectedParams = container.querySelector(`#${prefix}_${type}_params`);
    if (selectedParams) selectedParams.style.display = 'block';
}

function addSector(data = {}) {
    sectorCount++;
    const sectorId = data.id || `sector-${sectorCount}`;
    const newSector = document.createElement('div');
    newSector.className = 'sector-card bg-gray-700 p-4 rounded-lg border border-gray-600';
    newSector.id = sectorId;
    newSector.innerHTML = `
        <div class="flex justify-between items-center mb-3">
            <h4 class="font-semibold text-white">Sector de Protección #${sectorCount}</h4>
            <button onclick="removeSector('${sectorId}')" class="text-gray-500 hover:text-red-400 text-2xl leading-none">&times;</button>
        </div>
        <div class="space-y-3">
            <input type="text" placeholder="Nombre (Ej: Taller)" class="sector-name w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-1.5 text-sm" value="${data.name || `Sector ${sectorCount}`}">
            <div>
                <label class="text-xs text-gray-400">Sensibilidad Diferencial (IΔn)</label>
                <select class="sector-rcd w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-1.5 mt-1 text-sm">
                    <option value="30">30 mA</option><option value="100">100 mA</option><option value="300">300 mA</option>
                    <option value="500">500 mA</option><option value="1000">1 A</option><option value="3000">3 A</option>
                </select>
            </div>
             <div class="mt-2">
                <label class="flex items-center space-x-2 text-sm cursor-pointer">
                    <input type="checkbox" class="sector-manual-check form-checkbox h-4 w-4 text-blue-600 bg-gray-700 border-gray-500 rounded">
                    <span>Usar objetivo manual</span>
                </label>
                <input type="number" class="sector-manual-input w-full bg-gray-600 border-gray-500 rounded-md px-3 py-1.5 mt-2 hidden" placeholder="Ej: 5 Ω">
            </div>
            <div>
                <label class="text-xs text-gray-400">Tipo de Electrodo</label>
                <select class="sector-electrode-type w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-1.5 mt-1 text-sm">
                     <option value="jabalina_v" selected>Jabalina Vertical</option>
                </select>
            </div>
            <div class="sector-l-d-params">
                 <label class="text-xs text-gray-400">Jabalina del Sector</label>
                <div class="grid grid-cols-2 gap-2 mt-1">
                    <select class="sector-l w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-1.5 text-sm"><option value="1.5">1.5m</option><option value="3" selected>3m</option></select>
                    <select class="sector-d w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-1.5 text-sm"><option value="0.0127">1/2"</option><option value="0.0158">5/8"</option><option value="0.01905" selected>3/4"</option></select>
                </div>
            </div>
        </div>`;
    
    // Set values from data if available
    if (data.rcd) newSector.querySelector('.sector-rcd').value = data.rcd;
    if (data.manualCheck) {
        newSector.querySelector('.sector-manual-check').checked = true;
        newSector.querySelector('.sector-manual-input').value = data.manualInput || '';
        newSector.querySelector('.sector-manual-input').classList.remove('hidden');
    }
    if(data.electrodeType) newSector.querySelector('.sector-electrode-type').value = data.electrodeType;
    if(data.l) newSector.querySelector('.sector-l').value = data.l;
    if(data.d) newSector.querySelector('.sector-d').value = data.d;


    newSector.querySelector('.sector-manual-check').addEventListener('change', (e) => {
        e.target.closest('div').querySelector('.sector-manual-input').classList.toggle('hidden', !e.target.checked);
        saveState();
    });
    
    // In project mode, only jabalina_v is supported for simplicity in this version.
    newSector.querySelector('.sector-electrode-type').disabled = true;

    dom.sectoresContainer.appendChild(newSector);
    // Add listeners to new elements
    newSector.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('change', saveState);
        el.addEventListener('keyup', saveState);
    });
}

getElement('domiciliaria_manual_obj_check').addEventListener('change', (e) => {
    getElement('domiciliaria_manual_obj_input').classList.toggle('hidden', !e.target.checked);
    saveState();
});
getElement('proyecto_service_manual_check').addEventListener('change', (e) => {
    getElement('proyecto_service_manual_input').classList.toggle('hidden', !e.target.checked);
    saveState();
});

function removeSector(sectorId) { 
    getElement(sectorId).remove(); 
    saveState();
}

function getInputs() {
    const resistividadBase = dom.tipoSuelo.value === 'custom' ? parseFloat(dom.resistividadManual.value) : parseFloat(dom.tipoSuelo.value);
    const humedadFactor = parseFloat(dom.humedadTerreno.value);
    const resistividadFinal = resistividadBase * humedadFactor;

    const mode = dom.mode_selector.value;
    const baseParams = { 
        mode, 
        ul: dom.ul_condition.value, 
        resistividad: isNaN(resistividadFinal) ? 0 : resistividadFinal 
    };

    if (mode === 'proyecto') {
        baseParams.sectores = Array.from(document.querySelectorAll('.sector-card')).map(card => ({
            name: card.querySelector('.sector-name').value,
            rcd: card.querySelector('.sector-rcd').value,
            l: parseFloat(card.querySelector('.sector-l').value),
            d: parseFloat(card.querySelector('.sector-d').value),
            manualCheck: card.querySelector('.sector-manual-check').checked,
            manualInput: parseFloat(card.querySelector('.sector-manual-input').value),
            electrodeType: 'jabalina_v' // Hardcoded for project sectors in this version
        }));
        baseParams.service = {
             l: parseFloat(getElement('proyecto_service_l').value),
             d: parseFloat(getElement('proyecto_service_d').value),
             manualCheck: getElement('proyecto_service_manual_check').checked,
             manualInput: parseFloat(getElement('proyecto_service_manual_input').value)
        };
    } else {
        baseParams.domiciliaria = {
            rcd: getElement('domiciliaria_rcd').value,
            manualCheck: getElement('domiciliaria_manual_obj_check').checked,
            manualInput: parseFloat(getElement('domiciliaria_manual_obj_input').value),
            electrodeType: getElement('domiciliaria_electrode_type').value,
            l: parseFloat(getElement('domiciliaria_l').value),
            d: parseFloat(getElement('domiciliaria_d').value),
            h_l: parseFloat(getElement('domiciliaria_h_l').value),
            h_p: parseFloat(getElement('domiciliaria_h_p').value),
            placa_a: parseFloat(getElement('domiciliaria_placa_a').value),
            placa_b: parseFloat(getElement('domiciliaria_placa_b').value),
            malla_l: parseFloat(getElement('domiciliaria_malla_l').value),
            malla_A: parseFloat(getElement('domiciliaria_malla_A').value),
        };
    }
    return baseParams;
}

function getPatObjective(rcd, ul, manualCheck, manualValue) {
    if(manualCheck && !isNaN(manualValue) && manualValue > 0) return manualValue;
    const calculated_ra = DB.aeaTable[ul]?.[rcd] || Infinity;
    const capped_ra = DB.aeaFinalCap[rcd] || calculated_ra;
    return Math.min(calculated_ra, capped_ra);
}

// --- CALCULATION FUNCTIONS ---
function calculateJabalinaVertical(resistividad, L, d) {
    if (L <= 0 || d <= 0) return Infinity;
    // Formula from "apunte 4 massa.pdf", page 20.
    return (resistividad / (2 * Math.PI * L)) * Math.log((4 * L / d) - 1);
}

function calculateJabalinaHorizontal(resistividad, L, p) {
    if (L <= 0 || p <= 0) return Infinity;
    // Simplified formula for horizontal conductor
    return (resistividad / (2 * Math.PI * L)) * (Math.log((4 * L * L) / p) - 1);
}

function calculatePlaca(resistividad, a, b) {
    if (a <= 0 || b <= 0) return Infinity;
    // Simplified formula for rectangular plate (Schwarz)
    const P = 2 * (a + b); // Perimeter
    return (resistividad / P) * (Math.PI / 2);
}

function calculateMalla(resistividad, L_total, Area) {
    if (L_total <= 0 || Area <= 0) return Infinity;
    // Dwight's formula (simplified)
    return resistividad * ((1 / L_total) + (1 / Math.sqrt(20 * Area)));
}

function calculatePat(params, objetivo) {
    let Rj = Infinity;
    const { resistividad, electrodeType } = params;

    switch(electrodeType) {
        case 'jabalina_v':
            Rj = calculateJabalinaVertical(resistividad, params.l, params.d);
            break;
        case 'jabalina_h':
            Rj = calculateJabalinaHorizontal(resistividad, params.h_l, params.h_p);
            break;
        case 'placa':
            Rj = calculatePlaca(resistividad, params.placa_a, params.placa_b);
            break;
        case 'malla':
             Rj = calculateMalla(resistividad, params.malla_l, params.malla_A);
            break;
    }

    let numElectrodos = 0, Rt = Infinity;
    if (Rj <= objetivo) {
        numElectrodos = 1; Rt = Rj;
    } else if (electrodeType === 'jabalina_v') { // Parallel only for vertical javelins
        for (let i = 2; i <= 10; i++) {
            const k = DB.parallelCoefficients[i];
            const currentRt = k * Rj;
            if (currentRt <= objetivo) { numElectrodos = i; Rt = currentRt; break; }
        }
        if (numElectrodos === 0) { numElectrodos = 10; Rt = DB.parallelCoefficients[10] * Rj; }
    } else {
        // For other types, if one doesn't meet, it fails (simplification)
        numElectrodos = 1;
        Rt = Rj;
    }
    
    // Separation calculation is only relevant for vertical javelins
    const Re = (electrodeType === 'jabalina_v' && params.l > 0 && params.d > 0) ? (params.l / Math.log(params.l / params.d)) : 0;
    
    return { Rj, Rt, numElectrodos, Re, cumple: Rt <= objetivo, objetivo, ...params };
}
    
function performCalculations() {
    const params = getInputs();
    if (params.resistividad <= 0) {
        alert('Por favor, ingrese un valor de resistividad válido.');
        dom.loaderContainer.style.display = 'none';
        dom.initialMessage.style.display = 'flex';
        return;
    }

    if (params.mode === 'proyecto') {
        const srv = params.service;
        const srvObjective = srv.manualCheck && !isNaN(srv.manualInput) ? srv.manualInput : 1.0;
        const patServiceParams = { resistividad: params.resistividad, electrodeType: 'jabalina_v', l: srv.l, d: srv.d };
        const patService = calculatePat(patServiceParams, srvObjective);
        patService.isManual = srv.manualCheck;

        const patProteccion = params.sectores.map(sector => {
            const objective = getPatObjective(sector.rcd, params.ul, sector.manualCheck, sector.manualInput);
            const patParams = { resistividad: params.resistividad, electrodeType: sector.electrodeType, l: sector.l, d: sector.d };
            const result = {
                ...calculatePat(patParams, objective),
                name: sector.name, rcd: sector.rcd, isManual: sector.manualCheck
            };
            return result;
        });
        currentResults = { params, patService, patProteccion };
    } else {
        const p = params.domiciliaria;
        const objective = getPatObjective(p.rcd, params.ul, p.manualCheck, p.manualInput);
        const patParams = { resistividad: params.resistividad, ...p };
        const patUnica = calculatePat(patParams, objective);
        patUnica.isManual = p.manualCheck;
        patUnica.rcd = p.rcd;
        currentResults = { params, patUnica };
    }
    displayResults(currentResults);
}

// --- DISPLAY FUNCTIONS ---
function displayResults(results) {
    dom.loaderContainer.style.display = 'none';
    dom.resultsContainer.style.display = 'block';
    const content = results.params.mode === 'proyecto' ? generateProjectContent(results) : generateDomiciliariaContent(results);
    dom.resultsContainer.innerHTML = content;
    document.querySelectorAll('.tab-button').forEach(button => button.addEventListener('click', e => switchTab(e.currentTarget)));
    getElement('results-container').addEventListener('click', (e) => {
        if (e.target.id === 'exportTxtBtn') exportToTxt();
        if (e.target.id === 'exportCsvBtn') exportToCsv();
    });
    if (window.MathJax) MathJax.typesetPromise();
    switchTab(document.querySelector('.tab-button[data-tab="resultados"]'));
}
    
function generateBaseLayout(title, content) {
     return `
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b border-gray-600 pb-4">
            <h2 class="text-2xl font-semibold">${title}</h2>
            <div class="flex space-x-2 mt-4 sm:mt-0">
                <button id="exportTxtBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center text-sm">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Copiar Informe
                </button>
                <button id="exportCsvBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center text-sm">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Exportar CSV
                </button>
            </div>
        </div>
        <div class="border-b border-gray-600 mb-6">
            <nav class="flex space-x-1 sm:space-x-2 overflow-x-auto" aria-label="Tabs">
                <button class="tab-button active py-2 px-3 sm:px-4 text-sm font-medium" data-tab="resultados">Resultados</button>
                <button class="tab-button py-2 px-3 sm:px-4 text-sm font-medium" data-tab="calculos">Anexo: Cálculos</button>
                <button class="tab-button py-2 px-3 sm:px-4 text-sm font-medium" data-tab="formulas">Anexo: Fórmulas</button>
                <button class="tab-button py-2 px-3 sm:px-4 text-sm font-medium" data-tab="tablas">Anexo: Tablas</button>
            </nav>
        </div>
        <div id="tab-content">${content}</div>`;
}

function switchTab(clickedButton) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    clickedButton.classList.add('active');
    document.querySelectorAll('.result-section').forEach(section => section.style.display = 'none');
    getElement(`tab-${clickedButton.dataset.tab}`).style.display = 'block';
}

// --- CONTENT GENERATORS ---
function generateProjectContent(results) { return generateBaseLayout("Resultados del Proyecto (Esquema TT)", `${generateProjectResultsTab(results)}${generateProjectCalculosTab(results)}${generateFormulasTab()}${generateTablasTab()}`); }
function generateDomiciliariaContent(results) { return generateBaseLayout("Resultados Verificación Domiciliaria", `${generateDomiciliariaResultsTab(results)}${generateDomiciliariaCalculosTab(results)}${generateFormulasTab()}${generateTablasTab()}`); }

function createResultCard(title, id, {Rt, Rj, numElectrodos, cumple, objetivo, rcd, isManual, electrodeType}) {
    const statusClass = cumple ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800';
    const objectiveType = isManual ? '(Manual)' : `(Reglamento, ${rcd}mA)`;
    const solutionText = electrodeType === 'jabalina_v' ? `${numElectrodos} Jabalina(s)` : '1 Electrodo';
    
    return `<div class="bg-gray-700 p-4 rounded-lg flex flex-col h-full">
                <h4 class="font-bold text-lg text-white">${title} <span class="text-sm font-normal text-gray-400">(${id})</span></h4>
                <div class="mt-3 space-y-2 text-sm flex-grow">
                    <div class="flex justify-between"><span>Resistencia 1 Electrodo (Rj):</span><span class="font-semibold">${Rj.toFixed(2)} Ω</span></div>
                    <div class="flex justify-between"><span>Objetivo ${objectiveType}:</span><span class="font-semibold">≤ ${objetivo.toFixed(1)} Ω</span></div>
                    <hr class="border-gray-600">
                    <div class="flex justify-between text-base"><b>Solución Propuesta:</b><span class="font-bold">${solutionText}</span></div>
                    <div class="flex justify-between"><span>Resistencia Final (RT):</span><span class="font-bold text-lg">${Rt.toFixed(2)} Ω</span></div>
                </div>
                <div class="mt-4">
                    ${generateSvgResult(numElectrodos, electrodeType)}
                </div>
                <div class="mt-3 text-center text-sm font-bold p-1 rounded ${statusClass}">${cumple ? 'CUMPLE' : 'NO CUMPLE'}</div>
            </div>`;
}
function generateProjectResultsTab({ patService, patProteccion }) {
    const serviceCard = createResultCard('Puesta a Tierra de Servicio', 'RB', patService);
    const protectionCards = patProteccion.map((p, i) => createResultCard(p.name, `RA${i+1}`, p)).join('');
    return `<div id="tab-resultados" class="result-section space-y-6"><div><h3 class="text-xl font-semibold text-blue-400 mb-3">1. Sistema de Servicio (Neutro)</h3><p class="text-sm text-gray-400 mb-2">Puesta a tierra para estabilidad de la red.</p>${serviceCard}</div><div><h3 class="text-xl font-semibold text-blue-400 mb-3">2. Sistemas de Protección (Masas)</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${protectionCards}</div></div><div><h3 class="text-xl font-semibold text-blue-400 mb-3">3. Requisito de Separación</h3><div class="bg-gray-700 p-4 rounded-lg"><p class="text-sm text-gray-400">Separación Mínima entre Jabalinas de distintos sistemas (Recomendado > 5m). Aplicable solo a jabalinas verticales.</p><p class="text-2xl font-bold">${(patService.Re > 0 ? (patService.Re * 10).toFixed(2) : 'N/A')} m</p></div></div></div>`;
}
function generateProjectCalculosTab({ patService, patProteccion, params }) {
    const serviceCalc = `RT = K * Rj = ${DB.parallelCoefficients[patService.numElectrodos]} * ${patService.Rj.toFixed(2)} = ${patService.Rt.toFixed(2)} Ω`;
    const protectionCalcs = patProteccion.map((p, i) => `<div class="bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-2 text-blue-400">Cálculo para ${p.name} (RA${i+1})</h4><p class="font-mono text-sm break-words">Rj = (${params.resistividad.toFixed(2)} / (2π * ${p.l})) * ln((4*${p.l}/${p.d}) - 1) = ${p.Rj.toFixed(2)} Ω</p><p class="font-mono text-sm break-words">RT = K * Rj = ${DB.parallelCoefficients[p.numElectrodos]} * ${p.Rj.toFixed(2)} = ${p.Rt.toFixed(2)} Ω</p><p class="text-xs text-gray-400 mt-2">Objetivo ${p.isManual ? '(Manual)' : `(Reglamento, ${p.rcd}mA, UL=${params.ul}V)`}: ≤ ${p.objetivo} Ω</p></div>`).join('');
    return `<div id="tab-calculos" class="result-section space-y-4"><div class="bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-2 text-blue-400">Cálculo para Servicio (RB)</h4><p class="font-mono text-sm break-words">Rj (${patService.l}m x ${patService.d}m) = (${params.resistividad.toFixed(2)} / (2π * ${patService.l})) * ln((4*${patService.l}/${patService.d}) - 1) = ${patService.Rj.toFixed(2)} Ω</p><p class="font-mono text-sm break-words">${serviceCalc}</p></div>${protectionCalcs}</div>`;
}
function generateDomiciliariaResultsTab({ patUnica }) {
    return `<div id="tab-resultados" class="result-section">${createResultCard('Verificación Domiciliaria', 'RA', patUnica)}</div>`;
}
function generateDomiciliariaCalculosTab({ patUnica, params }) {
    const { Rj, Rt, numElectrodos, objetivo, rcd, isManual, electrodeType } = patUnica;
    const { resistividad, ul } = params;
    let rjFormula = '';
    switch(electrodeType){
        case 'jabalina_v': rjFormula = `Rj = (${resistividad.toFixed(2)} / (2π * ${patUnica.l})) * ln((4*${patUnica.l}/${patUnica.d}) - 1) = ${Rj.toFixed(2)} Ω`; break;
        case 'jabalina_h': rjFormula = `Rj = (${resistividad.toFixed(2)} / (2π * ${patUnica.h_l})) * (ln(4*${patUnica.h_l}²/${patUnica.h_p}) - 1) = ${Rj.toFixed(2)} Ω`; break;
        case 'placa': rjFormula = `Rj ≈ (${resistividad.toFixed(2)} / (2*(${patUnica.placa_a}+${patUnica.placa_b}))) * (π/2) = ${Rj.toFixed(2)} Ω`; break;
        case 'malla': rjFormula = `Rj ≈ ${resistividad.toFixed(2)} * (1/${patUnica.malla_l} + 1/√20*${patUnica.malla_A}) = ${Rj.toFixed(2)} Ω`; break;
    }

    return `<div id="tab-calculos" class="result-section space-y-4">
        <div class="bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-2 text-blue-400">1. Cálculo de Resistencia de Electrodo (Rj)</h4><p class="font-mono text-sm break-words">${rjFormula}</p></div>
        <div class="bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-2 text-blue-400">2. Determinación de Resistencia Máxima (RA max)</h4><p class="font-mono text-sm break-words">${ isManual ? `Objetivo Manual: ${objetivo} Ω` : `RA_max = min(UL/IΔn, Límite_Tabla) = ${objetivo} Ω`}</p></div>
        <div class="bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-2 text-blue-400">3. Cálculo de Sistema Final (RT)</h4><p class="font-mono text-sm break-words">${numElectrodos === 1 ? 'RT = Rj' : `RT = K * Rj = ${DB.parallelCoefficients[numElectrodos]} * ${Rj.toFixed(2)}`} = ${Rt.toFixed(2)} Ω</p></div>
        </div>`;
}
 function generateFormulasTab() {
     return `<div id="tab-formulas" class="result-section space-y-6">
        <div><h4 class="font-semibold text-lg text-blue-400">Resistencia Jabalina Vertical (Rj)</h4><div class="bg-gray-700 p-4 rounded-lg mt-2 font-mono text-center text-lg">$$ R_j = \\left(\\frac{\\rho}{2 \\cdot \\pi \\cdot L}\\right) \\cdot \\ln\\left(\\frac{4L}{d} - 1\\right) $$</div></div>
        <div><h4 class="font-semibold text-lg text-blue-400">Resistencia Jabalinas en Paralelo (RT)</h4><div class="bg-gray-700 p-4 rounded-lg mt-2 font-mono text-center text-lg">$$ R_T = K \\cdot R_j $$</div></div>
        <div><h4 class="font-semibold text-lg text-blue-400">Resistencia Máxima de Protección (RA)</h4><div class="bg-gray-700 p-4 rounded-lg mt-2 font-mono text-center text-lg">$$ R_A \\le \\frac{U_L}{I_{\\Delta n}} $$</div></div>
        <p class="text-xs text-gray-400">Nota: Las fórmulas para placas, mallas y jabalinas horizontales son aproximaciones simplificadas para esta herramienta.</p>
        </div>`;
 }
 function generateTablasTab() {
     const soilRows = Object.entries(DB.soilResistivity).map(([val, name]) => `<tr><td class="p-3">${name}</td><td class="p-3 text-right">${val} Ω·m</td></tr>`).join('');
     const parallelRows = Object.entries(DB.parallelCoefficients).map(([n, k]) => `<tr><td class="p-3">${n}</td><td class="p-3 text-right">${k}</td></tr>`).join('');
     const rcdRows = Object.entries(DB.aeaFinalCap).map(([rcd, res]) => `<tr><td class="p-3">${parseInt(rcd) < 1000 ? rcd + ' mA' : rcd/1000 + ' A'}</td><td class="p-3 text-right">${DB.aeaTable['50'][rcd] || '-'} Ω</td><td class="p-3 text-right">${DB.aeaTable['24'][rcd] || '-'} Ω</td><td class="p-3 text-right font-bold text-white">${res} Ω</td></tr>`).join('');
     return `<div id="tab-tablas" class="result-section"><div class="grid grid-cols-1 gap-6"><div class="lg:col-span-2"><h4 class="font-semibold mb-3 text-blue-400">Tabla 1: Resistencia Máxima de Protección vs. Diferencial (AEA 90364)</h4><div class="overflow-x-auto bg-gray-700 rounded-lg"><table class="w-full text-sm text-left"><thead class="bg-gray-600 text-xs uppercase"><tr><th class="p-3" rowspan="2">Sensibilidad (IΔn)</th><th class="p-3 text-center" colspan="3">Resistencia Máxima (RA)</th></tr><tr><th class="p-3 text-right">UL = 50V</th><th class="p-3 text-right">UL = 24V</th><th class="p-3 text-right">Valor Final</th></tr></thead><tbody class="divide-y divide-gray-600">${rcdRows}</tbody></table></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div><h4 class="font-semibold mb-3 text-blue-400">Tabla 2: Resistividad del Terreno</h4><div class="overflow-x-auto bg-gray-700 rounded-lg"><table class="w-full text-sm text-left"><thead class="bg-gray-600 text-xs uppercase"><tr><th class="p-3">Tipo de Suelo</th><th class="p-3 text-right">Valor</th></tr></thead><tbody class="divide-y divide-gray-600">${soilRows}</tbody></table></div></div><div><h4 class="font-semibold mb-3 text-blue-400">Tabla 3: Coeficientes Paralelo (K)</h4><div class="overflow-x-auto bg-gray-700 rounded-lg"><table class="w-full text-sm text-left"><thead class="bg-gray-600 text-xs uppercase"><tr><th class="p-3">N° Jabalinas</th><th class="p-3 text-right">K</th></tr></thead><tbody class="divide-y divide-gray-600">${parallelRows}</tbody></table></div></div></div></div></div>`;
 }
 
// --- SVG & UTILITY FUNCTIONS ---
function generateSvgResult(count, type) {
    let svgContent = '';
    const spacing = 30;
    const totalWidth = count * 10 + (count - 1) * (spacing - 10);
    
    switch(type) {
        case 'jabalina_v':
            for (let i = 0; i < count; i++) {
                svgContent += `<rect x="${i * spacing}" y="10" width="10" height="50" fill="#9ca3af" />`;
            }
            if (count > 1) {
                svgContent += `<line x1="5" y1="5" x2="${totalWidth - 5}" y2="5" stroke="#9ca3af" stroke-width="2" />`;
                for (let i = 0; i < count; i++) {
                    svgContent += `<line x1="${i * spacing + 5}" y1="5" x2="${i * spacing + 5}" y2="10" stroke="#9ca3af" stroke-width="2" />`;
                }
            }
            return `<svg viewBox="-5 0 ${totalWidth + 10} 70" class="mx-auto h-20">${svgContent}</svg>`;
        case 'jabalina_h':
            return `<svg viewBox="0 0 100 30" class="mx-auto h-12"><rect x="5" y="10" width="90" height="10" fill="#9ca3af" /></svg>`;
        case 'placa':
            return `<svg viewBox="0 0 60 40" class="mx-auto h-16"><rect x="5" y="5" width="50" height="30" fill="#9ca3af" /></svg>`;
        case 'malla':
            return `<svg viewBox="0 0 100 60" class="mx-auto h-20">
                <defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="#9ca3af" stroke-width="1"/></pattern></defs>
                <rect width="100" height="60" fill="url(#grid)" stroke="#9ca3af" stroke-width="2" />
            </svg>`;
    }
    return '';
}

function exportToTxt() {
    // This function can be expanded to provide more detailed text reports
    if (!currentResults) { alert("Primero debe realizar un cálculo."); return; }
    let report = `Informe de Puesta a Tierra\n============================\n`;
    // Simplified report for brevity
    report += `Modo: ${currentResults.params.mode}\nResistividad: ${currentResults.params.resistividad.toFixed(2)} ohm.m\n`;
    if(currentResults.patUnica){
        report += `Resultado Domiciliaria: ${currentResults.patUnica.Rt.toFixed(2)} ohm (${currentResults.patUnica.cumple ? 'CUMPLE' : 'NO CUMPLE'})`;
    }
    dom.exportTextarea.value = report;
    dom.exportTextarea.select();
    try { document.execCommand('copy'); alert('¡Informe copiado al portapapeles!'); } catch (err) { alert('Error al copiar.'); }
}

function exportToCsv() {
    if (!currentResults) { alert("Primero debe realizar un cálculo."); return; }
    let csvContent = "data:text/csv;charset=utf-8,";
    const headers = "Tipo Sistema,Nombre/ID,Resultado,Resistencia Final (ohm),Electrodos Necesarios,Objetivo (ohm),Resistividad (ohm.m)\n";
    csvContent += headers;
    const { params } = currentResults;
     if (params.mode === 'proyecto') {
        const { patService, patProteccion } = currentResults;
        csvContent += `Servicio,RB,${patService.cumple ? 'CUMPLE' : 'NO CUMPLE'},${patService.Rt.toFixed(2)},${patService.numElectrodos},${patService.objetivo.toFixed(1)},${params.resistividad.toFixed(2)}\n`;
        patProteccion.forEach((p, i) => {
            csvContent += `Proteccion,${p.name} (RA${i+1}),${p.cumple ? 'CUMPLE' : 'NO CUMPLE'},${p.Rt.toFixed(2)},${p.numElectrodos},${p.objetivo.toFixed(1)},${params.resistividad.toFixed(2)}\n`;
        });
    } else {
        const { patUnica } = currentResults;
        csvContent += `Proteccion,Domiciliaria (RA),${patUnica.cumple ? 'CUMPLE' : 'NO CUMPLE'},${patUnica.Rt.toFixed(2)},${patUnica.numElectrodos},${patUnica.objetivo.toFixed(1)},${params.resistividad.toFixed(2)}\n`;
    }
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "calculo_puesta_a_tierra.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

</script>
</body>
</html>
